<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Queue - MPLP Growth Cockpit</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="sidebar">
      <div class="brand">ðŸš€ MPLP Growth</div>
      <ul class="nav-links">
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="queue.html" class="active">Queue</a></li>
        <li><a href="settings.html">Settings</a></li>
      </ul>
    </div>

    <div class="main-content">
      <header>
        <h1>
          Approval Queue
          <span style="font-size: 14px; color: var(--text-secondary); margin-left: 10px"
            >v0.7.3</span
          >
        </h1>
        <div class="status-badge" id="global-header-stats"></div>
      </header>

      <div
        class="queue-controls"
        style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px"
      >
        <div style="display: flex; gap: 10px">
          <input
            type="text"
            id="queue-search"
            placeholder="Search: target / org / author / platform / text..."
            style="
              flex: 1;
              padding: 10px;
              border: 1px solid var(--border-color);
              border-radius: 4px;
              background: var(--card-bg);
              color: var(--text-primary);
            "
            oninput="app.handlers.onSearchInput(event)"
          />
          <button class="btn btn-secondary" onclick="app.handlers.clearFilters()">Clear</button>
        </div>
        <div id="queue-filter-chips" style="display: flex; gap: 8px; flex-wrap: wrap">
          <button
            class="chip active"
            data-category="all"
            onclick="app.handlers.onCategoryChipClick('all')"
          >
            All
          </button>
          <button
            class="chip"
            data-category="outreach"
            onclick="app.handlers.onCategoryChipClick('outreach')"
          >
            Outreach
          </button>
          <button
            class="chip"
            data-category="inbox"
            onclick="app.handlers.onCategoryChipClick('inbox')"
          >
            Inbox
          </button>
          <button
            class="chip"
            data-category="publish"
            onclick="app.handlers.onCategoryChipClick('publish')"
          >
            Publish
          </button>
          <button
            class="chip"
            data-category="review"
            onclick="app.handlers.onCategoryChipClick('review')"
          >
            Review
          </button>
          <button
            class="chip"
            data-category="other"
            onclick="app.handlers.onCategoryChipClick('other')"
          >
            Other
          </button>
        </div>
      </div>

      <!-- Batch Toolbar (v0.7.2) -->
      <div
        id="batch-toolbar"
        style="
          display: none;
          margin-bottom: 12px;
          padding: 10px 14px;
          background: var(--card-bg);
          border: 1px solid var(--accent-color);
          border-radius: 6px;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <span
          id="batch-count"
          style="font-weight: bold; color: var(--accent-color); margin-right: 8px"
          >0 selected</span
        >
        <button
          class="btn btn-success"
          style="padding: 4px 12px; font-size: 12px"
          onclick="app.handlers.batchApprove()"
        >
          âœ“ Approve
        </button>
        <button
          class="btn btn-danger"
          style="padding: 4px 12px; font-size: 12px"
          onclick="app.handlers.batchReject()"
        >
          âœ— Reject
        </button>
        <button
          class="btn btn-outline"
          style="padding: 4px 12px; font-size: 12px"
          onclick="app.handlers.openBatchRedraftModal()"
        >
          â†» Redraft asâ€¦
        </button>
        <button
          class="btn btn-secondary"
          style="padding: 4px 12px; font-size: 12px; margin-left: auto"
          onclick="app.handlers.clearSelection()"
        >
          Clear
        </button>
      </div>

      <!-- Batch Result Modal -->
      <div id="batch-result-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px">
          <h2 style="margin-top: 0">Batch Result</h2>
          <div
            id="batch-result-body"
            style="font-size: 13px; max-height: 300px; overflow-y: auto"
          ></div>
          <div class="modal-actions" style="margin-top: 15px">
            <button class="btn btn-secondary" onclick="app.handlers.copyBatchSummary()">
              Copy Summary
            </button>
            <button
              class="btn btn-primary"
              onclick="document.getElementById('batch-result-modal').classList.add('hidden')"
            >
              OK
            </button>
          </div>
        </div>
      </div>

      <!-- Batch Redraft Modal -->
      <div id="batch-redraft-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px">
          <h2 style="margin-top: 0">Batch Redraft</h2>
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px">
            Re-draft all selected items with a different agent role.
          </p>
          <select
            id="batch-redraft-role"
            style="
              width: 100%;
              padding: 8px;
              margin-bottom: 15px;
              border: 1px solid var(--border-color);
              border-radius: 4px;
              background: var(--bg-color);
              color: var(--text-primary);
              font-size: 14px;
            "
          >
            <option value="">Select a roleâ€¦</option>
            <option value="Responder">Responder</option>
            <option value="BDWriter">BDWriter</option>
            <option value="Editor">Editor</option>
            <option value="Analyst">Analyst</option>
          </select>
          <div class="modal-actions">
            <button
              class="btn btn-secondary"
              onclick="document.getElementById('batch-redraft-modal').classList.add('hidden')"
            >
              Cancel
            </button>
            <button
              class="btn btn-primary"
              id="batch-redraft-submit"
              onclick="app.handlers.confirmBatchRedraft()"
            >
              Confirm Redraft
            </button>
          </div>
        </div>
      </div>

      <div id="queue-list" class="queue-list">
        <div class="card" style="text-align: center">Loading queue...</div>
      </div>
      <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px">
          <h2 style="margin-top: 0">Edit Draft</h2>
          <input type="hidden" id="edit-asset-id" />
          <textarea
            id="edit-textarea"
            rows="12"
            style="
              width: 100%;
              padding: 8px;
              margin-top: 10px;
              margin-bottom: 20px;
              font-family: monospace;
              border: 1px solid var(--border-color);
              border-radius: 4px;
            "
          ></textarea>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="app.handlers.closeEditModal()">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="app.handlers.saveEdit()">Save Draft</button>
          </div>
        </div>
      </div>

      <div id="redraft-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px">
          <h2 style="margin-top: 0">Re-draft as Role</h2>
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px">
            Re-run the deterministic executor with a different agent role. The draft text will be
            regenerated â€” no state will be advanced.
          </p>
          <input type="hidden" id="redraft-confirm-id" />
          <select
            id="redraft-role-select"
            style="
              width: 100%;
              padding: 8px;
              margin-bottom: 20px;
              border: 1px solid var(--border-color);
              border-radius: 4px;
              background: var(--bg-color);
              color: var(--text-primary);
              font-size: 14px;
            "
          >
            <option value="">Select a roleâ€¦</option>
            <option value="Responder">Responder</option>
            <option value="BDWriter">BDWriter</option>
            <option value="Editor">Editor</option>
            <option value="Analyst">Analyst</option>
          </select>
          <p
            id="redraft-selection-count"
            style="
              font-size: 12px;
              color: var(--text-secondary);
              margin-bottom: 15px;
              display: none;
            "
          ></p>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="app.handlers.closeRedraftModal()">
              Cancel
            </button>
            <button
              class="btn btn-primary"
              id="redraft-submit-btn"
              onclick="app.handlers.confirmRedraft()"
            >
              Confirm Redraft
            </button>
          </div>
        </div>
      </div>

      <div id="impact-modal" class="modal-overlay hidden">
        <div class="modal-content">
          <h2 style="margin-top: 0">Approval Impact</h2>
          <div style="margin-top: 10px; margin-bottom: 10px">
            <span id="impact-badge" class="badge"></span>
          </div>
          <div id="impact-role-badge"></div>
          <p id="impact-summary" style="color: var(--text-secondary)"></p>

          <div class="impact-section">
            <h4 style="color: var(--success-color); margin-bottom: 0">âœ“ Will Execute</h4>
            <ul id="impact-will-change"></ul>
          </div>

          <div class="impact-section">
            <h4 style="color: var(--danger-color); margin-bottom: 0">âœ— Will NOT Do</h4>
            <ul id="impact-will-not"></ul>
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="app.handlers.closeImpactModal()">
              Cancel
            </button>
            <button class="btn btn-success" id="impact-confirm-btn">Confirm Approval</button>
          </div>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        app.initGlobalHeader();
        app.initQueue();

        // Keyboard shortcuts (v0.7.2)
        document.addEventListener("keydown", (e) => {
          // Ignore when typing in input/textarea/select
          const tag = document.activeElement?.tagName;
          if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") {
            if (e.key === "Escape") {
              document.activeElement.blur();
            }
            return;
          }

          if (e.key === "/") {
            e.preventDefault();
            const search = document.getElementById("queue-search");
            if (search) search.focus();
            return;
          }

          if (e.key === "Escape") {
            // Close any visible modal
            document.querySelectorAll(".modal-overlay").forEach((m) => {
              if (!m.classList.contains("hidden")) {
                m.classList.add("hidden");
              }
            });
            return;
          }

          // Shift+A = batch approve, Shift+R = batch redraft, Shift+X = clear (v0.7.3)
          if (e.shiftKey && (e.key === "A" || e.key === "a")) {
            e.preventDefault();
            if (app.state.selectedIds.size > 0) app.handlers.batchApprove();
            return;
          }
          if (e.shiftKey && (e.key === "R" || e.key === "r")) {
            e.preventDefault();
            if (app.state.selectedIds.size > 0) app.handlers.openBatchRedraftModal();
            return;
          }
          if (e.shiftKey && (e.key === "X" || e.key === "x")) {
            e.preventDefault();
            app.handlers.clearSelection();
            return;
          }

          // A = approve first visible item, R = redraft first visible item
          const firstCard = document.querySelector("#queue-list .queue-item");
          if (!firstCard) return;
          const confirmId = firstCard
            .querySelector(".batch-select-checkbox")
            ?.getAttribute("data-confirm-id");
          if (!confirmId) return;

          if (e.key === "a" || e.key === "A") {
            e.preventDefault();
            const impactBtn = firstCard.querySelector(".btn-primary[onclick*='openImpactModal']");
            if (impactBtn) impactBtn.click();
            return;
          }

          if (e.key === "r" || e.key === "R") {
            e.preventDefault();
            const redraftBtn = firstCard.querySelector(".btn-outline[onclick*='openRedraftModal']");
            if (redraftBtn) redraftBtn.click();
            return;
          }
        });
      });
    </script>
  </body>
</html>
